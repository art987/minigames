<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>海报编辑器-朋友圈海报制作中心</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 整合后的样式文件 -->
  <link rel="stylesheet" href="styles.css">
  <!-- html2canvas 用于图片导出 -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- 节日数据 -->
  <script src="festivals.js"></script>
  <!-- 模板数据 - 动态加载防止缓存 -->
  <script>
    // 创建带有时间戳的模板脚本标签，确保每次加载最新版本
    const templateScript = document.createElement('script');
    templateScript.src = 'templates.js?t=' + new Date().getTime();
    document.head.appendChild(templateScript);
  </script>
  <!-- 工具函数 -->
  <script src="utils.js"></script>
  <!-- 网站配置数据（包含券码验证） -->
  <script src="config_data.js"></script>
  <!-- VIP数据 -->
  <script src="vip_data.js"></script>
</head>
<body class="editorbg">
  <!-- 顶部返回按钮 -->
  <div class="back-button-container">
    <button id="backToHomeBtn" title="返回首页">
      <i class="fa fa-arrow-left"></i>
    </button>
  </div>

  <!-- VIP状态显示 -->
  <div id="vipStatusBar" class="vip-status-bar hidden">
    <div class="vip-status-content">
      <i class="fa fa-diamond"></i>
      <span>VIP用户已登录</span>
      <span class="vip-valid-until">有效期至：<span id="vipValidUntilDate"></span></span>
    </div>
  </div>

  <!-- 预览区域 -->
  <div class="preview-wrapper">
    <div id="posterFrame" class="poster-frame">
      <!-- 海报背景 -->
      <img id="posterBackground" class="poster-background" src="" alt="海报背景">
      
      <!-- 海报内容 -->
      <div id="posterContent" class="poster-content">
        <!-- 海报头部（商家Logo和名称） -->
        <div class="poster-header">
          <div id="posterLogo" class="poster-logo">
            <img id="posterLogoImg" src="" alt="商家Logo" >
            <i class="fa fa-building text-gray-400" id="logoPlaceholder"></i>
          </div>
          <div id="posterBusinessName" class="poster-business-name">点击编辑商家名称</div>
        </div>
        
        <!-- 中间透明触发区域（用于模板选择） -->
        <div id="templateTriggerArea" class="template-trigger-area"></div>
        
        <!-- 海报底部（二维码和促销信息） -->
        <div class="poster-footer">
          <div id="posterQrcode" class="poster-qrcode">
            <img id="posterQrcodeImg" src="" alt="二维码" >
            <i class="fa fa-qrcode text-gray-400" id="qrcodePlaceholder"></i>
          </div>
          <div id="posterPromoText" class="poster-promo-text">点击编辑促销信息</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 隐藏的背景上传区域 -->
  <div class="hidden">
    <input type="file" id="backgroundInput" accept="image/*" class="hidden">
  </div>
  
  <!-- 底部固定按钮栏 -->
  <div class="bottom-actions">
    <button id="changeTemplateBtn" class="action-btn">
      <i class="fa fa-th-large"></i>
      <span>选择模板</span>
    </button>
    <button id="editBusinessInfoBtn" class="action-btn">
      <i class="fa fa-building"></i>
      <span>商家信息</span>
    </button>
    <button id="uploadBackgroundBtn" class="action-btn">
      <i class="fa fa-upload"></i>
      <span>上传背景</span>
    </button>
    <button id="downloadBtn" class="action-btn">
      <i class="fa fa-download"></i>
      <span>下载海报</span>
    </button>
  </div>
  
  <!-- 海报生成加载动画 -->
  <div id="posterLoadingOverlay" class="poster-loading-overlay hidden">
    <div class="loading-container">
      <!-- 外围快速旋转的圆点线 -->
      <div class="outer-rotation">
        <div class="dot-ring">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
      
      <!-- 中心商家Logo缓慢旋转 -->
      <div class="logo-rotation">
        <img id="loadingLogo" src="" alt="商家Logo" class="loading-logo">
        <div class="logo-placeholder">
          <i class="fa fa-building"></i>
        </div>
      </div>
      
      <!-- 加载文字 -->
      <div class="loading-text">海报加速生成中...</div>
    </div>
  </div>
  
  <!-- 模板加载动画 -->
  <div id="templateLoadingOverlay" class="template-loading-overlay hidden">
    <div class="loading-container">
      <!-- 外围快速旋转的圆点线 -->
      <div class="outer-rotation">
        <div class="dot-ring">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
      
      <!-- 中心商家Logo缓慢旋转 -->
      <div class="logo-rotation">
        <img id="templateLoadingLogo" src="" alt="商家Logo" class="loading-logo">
        <div class="logo-placeholder">
          <i class="fa fa-building"></i>
        </div>
      </div>
      
      <!-- 加载文字 -->
      <div class="loading-text">模板加载中...</div>
    </div>
  </div>

  <!-- 模板选择弹窗 -->
  <div id="templateModal" class="modal-overlay hidden">
    <div class="modal template-select-modal">
      <div class="modal-header fixed-header">
        <h2 class="modal-title">选择模板(根据月份及节日)</h2>
        <button id="closeTemplateModalBtn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body scrollable-body">
        <!-- 月份选择 -->
        <div class="modal-months-container">
          <h3 class="text-lg font-medium mb-3" style="display: none;">选择月份</h3>
          <div class="modal-months-grid" id="modalMonthButtons"></div>
        </div>
        
        <!-- 节日选择 -->
        <div class="modal-festivals-container">
          <h3 class="text-lg font-medium mb-3" style="display: none;">选择节日</h3>
          <div class="modal-festivals-scroll">
            <div class="modal-festivals-grid" id="modalFestivalTags"></div>
          </div>
        </div>
        
        <!-- 模板列表 -->
        <div class="mt-6">
          <div id="modalTemplatesGrid"></div>
        </div>
      </div>
      <div class="modal-footer" style="display: none;">
        <button id="cancelTemplateBtn" class="editor-button editor-button-secondary">取消</button>
        <button id="confirmTemplateBtn" class="editor-button">确定</button>
      </div>
    </div>
  </div>

  <!-- 商家信息编辑弹窗 -->
  <div id="businessInfoModal" class="modal-overlay hidden">
    <div class="modal business-info-modal">
      <div class="modal-header fixed-header">
        <h2 class="modal-title">编辑商家信息</h2>
        <button id="closeBusinessInfoModalBtn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body scrollable-body">
        <form id="businessInfoForm">
          <div class="form-group">
            <label class="form-label" for="business-name">商家名称（含字体颜色） <span class="text-error-color">*</span></label>
            <div class="items-center">
              <input type="text" id="business-name" class="form-input" placeholder="请输入商家名称" required>
              <div class="color-select-container">
                <label class="form-label-sm">字体颜色:</label>
                <div class="color-swatch-group">
                  <div class="color-swatch" data-color="#000000" style="background-color: #000000; border: 2px solid #333;" title="黑色"></div>
                  <div class="color-swatch" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ddd;" title="白色"></div>
                  <div class="color-swatch" data-color="#b50000" style="background-color: #b50000;" title="玫瑰红"></div>
                  <div class="color-swatch" data-color="#800080" style="background-color: #800080;" title="紫色"></div>
                  <div class="color-swatch" data-color="#f02b55" style="background-color: #f02b55;" title="粉红"></div>
                  <div class="color-swatch" data-color="#0000CD" style="background-color: #0000CD;" title="普蓝"></div>
                   <div class="color-swatch" data-color="#1c8003" style="background-color: #1c8003;" title="绿色"></div>
                  <div class="color-swatch" data-color="#FFA500" style="background-color: #FFA500;" title="橘黄"></div>
                  <div class="color-swatch" data-color="#8B4513" style="background-color: #8B4513;" title="深褐"></div>
                </div>
                
              </div>
            </div>
          </div>
          
          <!-- 并排的上传区域 -->
          <div class="upload-container">
            <!-- Logo上传区域 -->
            <div>
              <label class="form-label" for="business-logo">商家Logo</label>
              <div id="logoUploadArea" class="upload-area">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12,19.2A6.8,6.8 0 0,1 5.2,12.4A6.806,6.806 0 0,1 12,5.6C17.3,5.6 21.6,10 21.6,15.2C21.6,17.5 20.8,19.7 19.2,21.2L12,21.2L12,19.2M12,17.73C10.8,17.73 9.73,16.67 9.73,15.47C9.73,14.27 10.8,13.2 12,13.2C13.2,13.2 14.27,14.27 14.27,15.47C14.27,16.67 13.2,17.73 12,17.73M12,4.93C7.13,4.93 3.14,8.87 3.14,13.67C3.14,18.47 7.13,22.4 12,22.4C16.87,22.4 20.86,18.47 20.86,13.67C20.86,8.87 16.87,4.93 12,4.93Z"/>
                </svg>
                <p class="upload-text">上传Logo</p>
                <p class="upload-hint">支持JPG、PNG格式</p>
                <input type="file" id="logoInput" accept="image/*" class="hidden">
              </div>
              <div id="logoPreview" class="upload-preview">
                <img id="logoPreviewImg" src="" alt="Logo预览" class="upload-preview-image">
                <button type="button" id="removeLogoBtn" class="upload-remove-btn">
                  <i class="fa fa-times"></i>
                </button>
              </div>
              <!-- VIP用户恢复原始Logo按钮 -->
              <div id="restoreLogoBtnContainer" class="restore-btn-container hidden">
                <button type="button" id="restoreLogoBtn" class="restore-btn">
                  <i class="fa fa-undo"></i> 恢复原始Logo
                </button>
              </div>
            </div>
            
            <!-- 二维码上传区域 -->
            <div>
              <label class="form-label" for="business-qrcode">二维码</label>
              <div id="qrcodeUploadArea" class="upload-area">
                <svg class="upload-icon" viewBox="0 0 1024 1024" fill="currentColor">
                  <path d="M384 64l-249.6 0c-51.2 0-89.6 41.6-89.6 89.6l0 227.2c0 51.2 41.6 89.6 89.6 89.6l249.6 0c51.2 0 89.6-41.6 89.6-89.6l0-227.2C473.6 105.6 435.2 64 384 64zM428.8 380.8c0 25.6-19.2 44.8-44.8 44.8l-249.6 0c-25.6 0-44.8-19.2-44.8-44.8l0-227.2c0-25.6 19.2-44.8 44.8-44.8l249.6 0c25.6 0 44.8 19.2 44.8 44.8L428.8 380.8z" fill="#cdcdcd"></path>
                  <path d="M192 192l134.4 0 0 134.4-134.4 0 0-134.4Z" fill="#cdcdcd"></path>
                  <path d="M377.6 544l-243.2 0c-48 0-86.4 38.4-86.4 89.6l0 220.8c0 48 38.4 89.6 86.4 89.6l243.2 0c48 0 86.4-38.4 86.4-89.6l0-220.8C467.2 582.4 425.6 544 377.6 544zM422.4 851.2c0 25.6-19.2 44.8-44.8 44.8l-243.2 0c-25.6 0-44.8-19.2-44.8-44.8l0-220.8c0-25.6 19.2-44.8 44.8-44.8l243.2 0c25.6 0 44.8 19.2 44.8 44.8L422.4 851.2z" fill="#cdcdcd"></path>
                  <path d="M192 668.8l131.2 0 0 131.2-131.2 0 0-131.2Z" fill="#cdcdcd"></path>
                  <path d="M633.6 470.4l249.6 0c51.2 0 89.6-41.6 89.6-89.6l0-227.2c0-51.2-41.6-89.6-89.6-89.6l-249.6 0c-51.2 0-89.6 41.6-89.6 89.6l0 227.2C544 432 585.6 470.4 633.6 470.4zM588.8 153.6c0-25.6 19.2-44.8 44.8-44.8l249.6 0c25.6 0 44.8 19.2 44.8 44.8l0 227.2c0 25.6-19.2 44.8-44.8 44.8l-249.6 0c-25.6 0-44.8-19.2-44.8-44.8L588.8 153.6z" fill="#cdcdcd"></path>
                  <path d="M700.8 192l134.4 0 0 134.4-134.4 0 0-134.4Z" fill="#cdcdcd"></path>
                  <path d="M572.8 716.8l137.6 0c12.8 0 22.4-9.6 22.4-22.4l0-137.6c0-12.8-9.6-22.4-22.4-22.4l-137.6 0c-12.8 0-22.4 9.6-22.4 22.4l0 137.6C550.4 707.2 560 716.8 572.8 716.8z" fill="#cdcdcd"></path>
                  <path d="M886.4 563.2l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C899.2 537.6 886.4 550.4 886.4 563.2z" fill="#cdcdcd"></path>
                  <path d="M886.4 716.8l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C899.2 691.2 886.4 704 886.4 716.8z" fill="#cdcdcd"></path>
                  <path d="M886.4 870.4l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C899.2 844.8 886.4 857.6 886.4 870.4z" fill="#cdcdcd"></path>
                  <path d="M710.4 563.2l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C723.2 537.6 710.4 550.4 710.4 563.2z" fill="#cdcdcd"></path>
                  <path d="M710.4 716.8l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C723.2 691.2 710.4 704 710.4 716.8z" fill="#cdcdcd"></path>
                  <path d="M710.4 870.4l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C723.2 844.8 710.4 857.6 710.4 870.4z" fill="#cdcdcd"></path>
                  <path d="M534.4 563.2l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C547.2 537.6 534.4 550.4 534.4 563.2z" fill="#cdcdcd"></path>
                  <path d="M534.4 716.8l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C547.2 691.2 534.4 704 534.4 716.8z" fill="#cdcdcd"></path>
                  <path d="M534.4 870.4l0 38.4c0 12.8 12.8 25.6 25.6 25.6l38.4 0c12.8 0 25.6-12.8 25.6-25.6l0-38.4c0-12.8-12.8-25.6-25.6-25.6l-38.4 0C547.2 844.8 534.4 857.6 534.4 870.4z" fill="#cdcdcd"></path>
                </svg>
                <p class="upload-text">上传二维码</p>
                <p class="upload-hint">支持JPG、PNG格式</p>
                <input type="file" id="qrcodeInput" accept="image/*" class="hidden">
              </div>
              <div id="qrcodePreview" class="upload-preview hidden">
                <img id="qrcodePreviewImg" src="" alt="二维码预览" class="upload-preview-image">
                <button type="button" id="removeQrcodeBtn" class="upload-remove-btn">
                  <i class="fa fa-times"></i>
                </button>
              </div>
              <!-- VIP用户恢复原始二维码按钮 -->
              <div id="restoreQrcodeBtnContainer" class="restore-btn-container hidden">
                <button type="button" id="restoreQrcodeBtn" class="restore-btn">
                  <i class="fa fa-undo"></i> 恢复原始二维码
                </button>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="promotion-text">促销信息</label>
            <textarea id="promotion-text" class="form-input" rows="3" placeholder="请输入促销信息，支持Enter键换行（如：全场8折\n限时优惠）"></textarea>
            <button id="selectPromoTemplateBtn" class="editor-button mt-2">选择促销文案模板编辑</button>
          </div>
        </form>
      </div>
      <div class="modal-footer" >
        <button id="cancelBusinessInfoBtn" class="editor-button editor-button-secondary">取消</button>
        <button id="saveBusinessInfoBtn" class="editor-button">保存</button>
      </div>
    </div>
  </div>
  
  <!-- 字体颜色选择弹窗 -->
  <div id="fontColorModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">选择字体颜色</h2>
        <button id="closeFontColorModalBtn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">可用颜色:</label>
          <div class="color-select-container">
            <div class="color-swatch-group">
              <div class="color-swatch" data-color="#000000" style="background-color: #000000; border: 2px solid #333;" title="黑色"></div>
              <div class="color-swatch" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ddd;" title="白色"></div>
              <div class="color-swatch" data-color="#b50000" style="background-color: #b50000;" title="玫瑰红"></div>
              <div class="color-swatch" data-color="#800080" style="background-color: #800080;" title="紫色"></div>
              <div class="color-swatch" data-color="#f02b55" style="background-color: #f02b55;" title="粉红"></div>
              <div class="color-swatch" data-color="#0000CD" style="background-color: #0000CD;" title="普蓝"></div>
              <div class="color-swatch" data-color="#1c8003" style="background-color: #1c8003;" title="绿色"></div>
              <div class="color-swatch" data-color="#FFA500" style="background-color: #FFA500;" title="橘黄"></div>
              <div class="color-swatch" data-color="#8B4513" style="background-color: #8B4513;" title="深褐"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- 移除底部按钮，因为点击颜色后立即应用并关闭弹窗 -->
    </div>
  </div>

  <!-- 编辑器脚本 -->
  <script src="editor-script.js"></script>
  
  <!-- 调试脚本 -->
  <script>
    // 编辑器加载调试
    document.addEventListener('DOMContentLoaded', function() {
      console.log('编辑器页面加载完成');
      
      // 获取URL参数
      const urlParams = new URLSearchParams(window.location.search);
      const templateId = urlParams.get('templateId');
      console.log('加载的模板ID:', templateId);
      
      // 编辑器调试器
      window.editorDebugger = {
        getCurrentTemplate: function() {
          return window.currentTemplate;
        },
        getBusinessInfo: function() {
          return window.businessInfo;
        },
        resetEditor: function() {
          if (window.resetEditor) {
            window.resetEditor();
          }
        }
      };
      
      console.log('编辑器调试器已加载:', window.editorDebugger);
    });
  </script>
  
  <!-- 促销信息编辑模态框 -->
  <div id="promoTextModal" class="modal-overlay hidden">
    <div class="modal-container promo-text-modal">
      <div class="modal-header fixed-header">
        <h3>编辑促销信息</h3>
        <button id="closePromoTextModal" class="modal-close">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body scrollable-body">
        <!-- 促销信息输入区域 -->
        <div class="input-section">
          <textarea id="promoTextInput" class="promo-text-input" rows="3" placeholder="请输入促销信息..."></textarea>
          <button id="savePromoTextBtn" class="btn-primary">保存</button><span>（您可以点选下方模板进行修改））</span>
        </div>
        
        <!-- 文案模板区域 -->
        <div class="templates-section">
          <div id="promoTemplatesList" class="promo-templates-list">
            <!-- 文案模板将通过JavaScript动态生成 -->
          </div>
        </div>
      </div>
      
    </div>
  </div>
</body>
</html>