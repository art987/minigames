<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>测试调试页面</h1>
    <p>此页面用于隔离测试文件加载问题。正在尝试加载单个测试文件...</p>
    
    <div id="status">
        <p>加载状态: <span id="loading-status">初始化中...</span></p>
        <p>错误信息: <span id="error-info" class="error">暂无</span></p>
        <p>数据集: <span id="dataset-info">未加载</span></p>
    </div>
    
    <script>
        // 初始化测试注册表和数据集容器
        window.TestRegistry = window.TestRegistry || {
            register: function(data) {
                console.log('TestRegistry.register: 注册测试成功:', data.id);
                document.getElementById('loading-status').innerHTML = 
                    '<span class="success">TestRegistry 注册成功</span>';
            },
            list: function() { return []; }
        };
        
        window.TestDatasets = window.TestDatasets || {};
        
        // 加载测试文件
        // 要加载的测试文件列表
        const testFiles = [
            'data/心理测评类/mbti_short.js',
            'data/心理测评类/stress_tolerance.js',
            'data/心理测评类/emotion_stability.js',
            'data/智力与逻辑类/iq60.js',
            'data/职业与学习类/creative_thinking.js'
        ];
        
        let loadedFiles = 0;
        let errorOccurred = false;
        
        function loadTestFile(filePath) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = filePath;
                script.onload = function() {
                    loadedFiles++;
                    document.getElementById('loading-status').textContent = 
                        `已加载 ${loadedFiles}/${testFiles.length} 个文件`;
                    resolve(filePath);
                };
                
                script.onerror = function(error) {
                    errorOccurred = true;
                    document.getElementById('error-info').textContent = 
                        `加载文件 ${filePath} 失败: ${error.toString()}`;
                    reject(error);
                };
                
                document.head.appendChild(script);
            });
        }
        
        function loadAllTestFiles() {
            try {
                // 添加错误捕获
                window.addEventListener('error', function(e) {
                    if (!errorOccurred) {
                        errorOccurred = true;
                        document.getElementById('error-info').textContent = 
                            'JavaScript错误: ' + e.error.message;
                        console.log('JavaScript错误:', e.error);
                        console.log('错误发生在文件:', e.filename, '行:', e.lineno);
                    }
                });
                
                // 使用简单的循环加载文件，不使用async/await
                for (let i = 0; i < testFiles.length; i++) {
                    if (errorOccurred) break;
                    // 延迟加载下一个文件，确保前一个文件完全加载
                    setTimeout(() => {
                        try {
                            const file = testFiles[i];
                            const script = document.createElement('script');
                            script.src = file;
                            
                            script.onload = function() {
                                loadedFiles++;
                                document.getElementById('loading-status').textContent = 
                                    `已加载 ${loadedFiles}/${testFiles.length} 个文件: ${file}`;
                                console.log('成功加载文件:', file);
                            };
                            
                            script.onerror = function() {
                                errorOccurred = true;
                                document.getElementById('error-info').textContent = 
                                    `加载文件 ${file} 失败`;
                                console.error('加载文件失败:', file);
                            };
                            
                            document.head.appendChild(script);
                        } catch (e) {
                            errorOccurred = true;
                            document.getElementById('error-info').textContent = 
                                `处理文件时出错: ${e.message}`;
                            console.error('处理文件时出错:', e);
                        }
                    }, i * 1000); // 每个文件间隔1秒加载
                }
                
                // 设置一个超时检查，查看所有文件是否加载成功
                setTimeout(() => {
                    if (!errorOccurred && loadedFiles === testFiles.length) {
                        document.getElementById('loading-status').innerHTML = 
                            '<span class="success">所有测试文件加载成功</span>';
                        
                        // 显示加载的数据集数量
                        if (window.TestDatasets) {
                            const datasetCount = Object.keys(window.TestDatasets).length;
                            document.getElementById('dataset-info').innerHTML = 
                                `<span class="success">已加载 ${datasetCount} 个数据集</span>`;
                            console.log('已加载的数据集:', Object.keys(window.TestDatasets));
                        }
                    }
                }, (testFiles.length + 1) * 1000);
            } catch (e) {
                document.getElementById('error-info').textContent = '初始化错误: ' + e.message;
                console.error('初始化错误:', e);
            }
        }
        
        // 页面加载后执行
        window.onload = loadAllTestFiles;
    </script>
</body>
</html>