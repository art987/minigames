<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå®ç¯å¢ƒè°ƒè¯• - æµ‹è¯•åŠ è½½é—®é¢˜</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; }
        .log-container { 
            background-color: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            height: 400px; 
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error { color: #d9534f; }
        .success { color: #5cb85c; }
        .info { color: #337ab7; }
        .loading { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3498db; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button { padding: 10px 15px; margin: 10px 0; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>çœŸå®ç¯å¢ƒè°ƒè¯• - æµ‹è¯•åŠ è½½é—®é¢˜</h1>
        <p>æ­¤é¡µé¢æŒ‰ç…§åŸå§‹index.htmlçš„ç»“æ„å’Œé¡ºåºåŠ è½½æ–‡ä»¶ï¼Œç”¨äºå®šä½"SyntaxError: Unexpected identifier 'questions'"é”™è¯¯</p>
        
        <div id="status">
            <div class="loading"></div>
            <span>åŠ è½½ä¸­...</span>
        </div>
        
        <div class="log-container" id="log-container"></div>
        
        <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
    </div>

    <script>
        // æ—¥å¿—è®°å½•åŠŸèƒ½
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å…¨å±€å˜é‡å­˜å‚¨åŠ è½½çŠ¶æ€
        window.DebugState = {
            loadedFiles: [],
            errorFiles: [],
            startTime: Date.now(),
            totalFiles: 0,
            currentFileIndex: 0,
            // æ·»åŠ ä¸€ä¸ªè®¡æ•°å™¨æ¥è·Ÿè¸ªé”™è¯¯
            errorCount: {
                total: 0,
                syntax: 0,
                questionsRelated: 0
            }
        };

        // é‡å†™console.logï¼Œæ•è·æ‰€æœ‰æ—¥å¿—è¾“å‡º
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            log(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '), 'info');
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            log(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '), 'error');
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            log(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '), 'warning');
            originalConsoleWarn.apply(console, args);
        };

        // åˆ›å»ºä¸€ä¸ªå¢å¼ºçš„é”™è¯¯å¤„ç†å™¨æ¥æ•è·æœªæ•è·çš„å¼‚å¸¸
        window.addEventListener('error', function(e) {
            window.DebugState.errorCount.total++;
            
            console.error(`æ•è·åˆ°å…¨å±€é”™è¯¯: ${e.message} (è¡Œå·: ${e.lineno}, åˆ—å·: ${e.colno}, æ–‡ä»¶: ${e.filename})`);
            
            // ç‰¹åˆ«å…³æ³¨questionsç›¸å…³çš„è¯­æ³•é”™è¯¯
            if (e.message && e.message.includes('questions')) {
                window.DebugState.errorCount.questionsRelated++;
                console.error('ğŸš¨ å‘ç°ä¸questionsç›¸å…³çš„è¯­æ³•é”™è¯¯ï¼Œè¿™å¯èƒ½æ˜¯æˆ‘ä»¬è¦æ‰¾çš„é—®é¢˜!');
                
                // å°è¯•è·å–å¹¶åˆ†æå‡ºé”™çš„æ–‡ä»¶å†…å®¹
                if (e.filename) {
                    fetch(e.filename)
                        .then(response => response.text())
                        .then(content => {
                            // æ‰¾åˆ°å‡ºé”™çš„è¡Œé™„è¿‘çš„ä»£ç 
                            const lines = content.split('\n');
                            const errorLine = e.lineno - 1; // è½¬æ¢ä¸º0-basedç´¢å¼•
                            const startLine = Math.max(0, errorLine - 5);
                            const endLine = Math.min(lines.length - 1, errorLine + 5);
                            
                            console.error(`\nğŸ“‹ å‡ºé”™æ–‡ä»¶çš„ç›¸å…³ä»£ç : ${e.filename}`);
                            for (let i = startLine; i <= endLine; i++) {
                                const prefix = (i === errorLine) ? 'âŒ ' : '   ';
                                console.error(`${prefix}${i+1}: ${lines[i]}`);
                            }
                        })
                        .catch(err => console.error('æ— æ³•è·å–å‡ºé”™æ–‡ä»¶çš„å†…å®¹:', err));
                }
            } else if (e.message && e.message.includes('SyntaxError')) {
                window.DebugState.errorCount.syntax++;
                console.error('âš ï¸ å‘ç°è¯­æ³•é”™è¯¯');
            }
        });

        // æ–‡ä»¶åŠ è½½å®Œæˆæ—¶çš„å›è°ƒ
        function onFileLoaded(fileName) {
            window.DebugState.loadedFiles.push(fileName);
            console.log(`âœ… æˆåŠŸåŠ è½½: ${fileName} (å·²åŠ è½½ ${window.DebugState.loadedFiles.length}/${window.DebugState.totalFiles} ä¸ªæ–‡ä»¶)`);
            
            // æ£€æŸ¥å½“å‰åŠ è½½çš„æ–‡ä»¶æ˜¯å¦åŒ…å«questionsç›¸å…³å†…å®¹
            setTimeout(() => {
                checkQuestionsInFile(fileName);
            }, 100);
            
            checkAllFilesLoaded();
        }

        // æ–‡ä»¶åŠ è½½é”™è¯¯æ—¶çš„å›è°ƒ
        function onFileError(fileName, error) {
            window.DebugState.errorFiles.push({ fileName, error: error.message || 'æœªçŸ¥é”™è¯¯' });
            window.DebugState.errorCount.total++;
            
            if (error.message && error.message.includes('SyntaxError')) {
                window.DebugState.errorCount.syntax++;
                console.error(`âŒ è¯­æ³•é”™è¯¯: ${fileName} - ${error.message}`);
            } else {
                console.error(`âŒ åŠ è½½å¤±è´¥: ${fileName} - ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
            
            checkAllFilesLoaded();
        }

        // æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦åŠ è½½å®Œæˆ
        function checkAllFilesLoaded() {
            const totalLoaded = window.DebugState.loadedFiles.length + window.DebugState.errorFiles.length;
            if (totalLoaded === window.DebugState.totalFiles) {
                const loadTime = (Date.now() - window.DebugState.startTime) / 1000;
                document.getElementById('status').innerHTML = '<span>åŠ è½½å®Œæˆ</span>';
                
                console.log(`
===== åŠ è½½æ€»ç»“ =====`);
                console.log(`æ€»æ–‡ä»¶æ•°: ${window.DebugState.totalFiles}`);
                console.log(`æˆåŠŸåŠ è½½: ${window.DebugState.loadedFiles.length}`);
                console.log(`åŠ è½½å¤±è´¥: ${window.DebugState.errorFiles.length}`);
                console.log(`åŠ è½½è€—æ—¶: ${loadTime}ç§’`);
                
                // é”™è¯¯ç»Ÿè®¡
                console.log(`
===== é”™è¯¯ç»Ÿè®¡ =====`);
                console.log(`æ€»é”™è¯¯æ•°: ${window.DebugState.errorCount.total}`);
                console.log(`è¯­æ³•é”™è¯¯: ${window.DebugState.errorCount.syntax}`);
                console.log(`Questionsç›¸å…³é”™è¯¯: ${window.DebugState.errorCount.questionsRelated}`);
                
                if (window.DebugState.errorFiles.length > 0) {
                    console.log(`\nå¤±è´¥æ–‡ä»¶åˆ—è¡¨:`);
                    window.DebugState.errorFiles.forEach(({ fileName, error }) => {
                        console.error(`- ${fileName}: ${error}`);
                    });
                }
                
                // æ£€æŸ¥TestDatasetså¯¹è±¡
                console.log(`\n===== TestDatasets æ£€æŸ¥ =====`);
                if (window.TestDatasets) {
                    const datasetKeys = Object.keys(window.TestDatasets);
                    console.log(`TestDatasets åŒ…å« ${datasetKeys.length} ä¸ªæ•°æ®é›†`);
                    // åˆ—å‡ºå‰5ä¸ªæ•°æ®é›†ä½œä¸ºç¤ºä¾‹
                    if (datasetKeys.length > 0) {
                        console.log(`å‰5ä¸ªæ•°æ®é›†:`);
                        datasetKeys.slice(0, 5).forEach(key => {
                            const dataset = window.TestDatasets[key];
                            const hasQuestions = dataset && dataset.questions && Array.isArray(dataset.questions);
                            console.log(`- ${key}: ${hasQuestions ? `æœ‰ ${dataset.questions.length} ä¸ªé—®é¢˜` : 'æ•°æ®ç»“æ„ä¸å®Œæ•´'}`);
                        });
                    }
                } else {
                    console.error(`âŒ TestDatasets å¯¹è±¡ä¸å­˜åœ¨`);
                }
                
                // æ£€æŸ¥TestConfigå¯¹è±¡
                console.log(`\n===== TestConfig æ£€æŸ¥ =====`);
                if (window.TestConfig) {
                    console.log(`TestConfig å·²åŠ è½½`);
                    try {
                        const categories = window.TestConfig.getAllCategories();
                        console.log(`TestConfig åŒ…å« ${Object.keys(categories).length} ä¸ªåˆ†ç±»`);
                    } catch (e) {
                        console.error(`TestConfig åŠŸèƒ½å¼‚å¸¸: ${e.message}`);
                    }
                } else {
                    console.error(`âŒ TestConfig å¯¹è±¡ä¸å­˜åœ¨`);
                }
            }
        }

        // å¢å¼ºçš„è„šæœ¬åŠ è½½å‡½æ•°ï¼Œæ·»åŠ è¯­æ³•é¢„æ£€æŸ¥
        function loadScript(url, callback, errorCallback) {
            const fileName = url.split('/').pop();
            console.log(`å¼€å§‹åŠ è½½: ${fileName}`);
            
            // å…ˆå°è¯•è·å–æ–‡ä»¶å†…å®¹è¿›è¡Œé¢„æ£€æŸ¥
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                    }
                    return response.text();
                })
                .then(content => {
                    try {
                        // é¢„æ£€æŸ¥è¯­æ³•ï¼ˆä¸ä¼šæ‰§è¡Œä»£ç ï¼‰
                        new Function(content);
                        console.log(`è¯­æ³•é¢„æ£€æŸ¥é€šè¿‡: ${fileName}`);
                        
                        // ç‰¹åˆ«æ£€æŸ¥estimateMinuteså’Œquestionsç›¸å…³çš„è¯­æ³•
                        checkEstimateMinutesAndQuestions(content, fileName);
                        
                        // åˆ›å»ºå¹¶åŠ è½½è„šæœ¬
                        const script = document.createElement('script');
                        script.src = url;
                        
                        const startTime = Date.now();
                        
                        script.onload = function() {
                            const loadTime = (Date.now() - startTime) / 1000;
                            callback(fileName, loadTime);
                        };
                        
                        script.onerror = function(error) {
                            errorCallback(fileName, error);
                        };
                        
                        document.head.appendChild(script);
                    } catch (error) {
                        console.error(`è¯­æ³•é¢„æ£€æŸ¥å¤±è´¥: ${fileName} - ${error.message}`);
                        window.DebugState.errorCount.syntax++;
                        errorCallback(fileName, error);
                    }
                })
                .catch(error => {
                    console.error(`é¢„æ£€æŸ¥å¤±è´¥: ${fileName} - ${error.message}`);
                    errorCallback(fileName, error);
                });
        }
        
        // æ£€æŸ¥estimateMinuteså’Œquestionsç›¸å…³çš„è¯­æ³•
        function checkEstimateMinutesAndQuestions(content, fileName) {
            // æ£€æŸ¥estimateMinutesåé¢æ˜¯å¦æœ‰é€—å·ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰æ³¨é‡Šçš„æƒ…å†µä¸‹
            const estimateMinutesRegex = /estimateMinutes:\s*\d+\s*(\/\/.*)?$/gm;
            let match;
            let hasPotentialIssue = false;
            
            while ((match = estimateMinutesRegex.exec(content)) !== null) {
                const line = match[0];
                if (!line.includes(',') && !line.includes('{') && !line.includes('}') && !line.includes(';')) {
                    console.warn(`âš ï¸ æ½œåœ¨é—®é¢˜: ${fileName} ä¸­çš„estimateMinutesåé¢å¯èƒ½ç¼ºå°‘é€—å·`);
                    console.warn(`   ä»£ç è¡Œ: ${line}`);
                    hasPotentialIssue = true;
                }
            }
            
            // æ£€æŸ¥questionsæ•°ç»„çš„å®šä¹‰
            const questionsRegex = /questions\s*[:=]\s*\[/;
            if (content.includes('questions') && !questionsRegex.test(content)) {
                console.warn(`âš ï¸ æ½œåœ¨é—®é¢˜: ${fileName} ä¸­å¯èƒ½å­˜åœ¨questionså®šä¹‰çš„è¯­æ³•é—®é¢˜`);
                hasPotentialIssue = true;
            }
            
            return hasPotentialIssue;
        }
        
        // æ£€æŸ¥æ–‡ä»¶ä¸­questionsæ•°æ®ç»“æ„çš„å®Œæ•´æ€§
        function checkQuestionsInFile(fileName) {
            // å°è¯•ä»æ–‡ä»¶åä¸­æå–æµ‹è¯•ID
            const testId = fileName.replace('.js', '');
            
            // æ£€æŸ¥TestDatasetsä¸­æ˜¯å¦å­˜åœ¨è¯¥æµ‹è¯•çš„æ•°æ®
            if (window.TestDatasets && window.TestDatasets[testId]) {
                const dataset = window.TestDatasets[testId];
                
                if (!dataset.questions) {
                    console.warn(`âš ï¸ è­¦å‘Š: ${fileName} ä¸­æ²¡æœ‰questionsæ•°ç»„`);
                } else if (!Array.isArray(dataset.questions)) {
                    console.warn(`âš ï¸ è­¦å‘Š: ${fileName} ä¸­çš„questionsä¸æ˜¯æ•°ç»„`);
                } else if (dataset.questions.length === 0) {
                    console.warn(`âš ï¸ è­¦å‘Š: ${fileName} ä¸­çš„questionsæ•°ç»„ä¸ºç©º`);
                } else {
                    // æ£€æŸ¥å‰å‡ ä¸ªé—®é¢˜çš„ç»“æ„æ˜¯å¦æ­£ç¡®
                    const sampleQuestions = dataset.questions.slice(0, 3);
                    sampleQuestions.forEach((question, index) => {
                        if (!question.text) {
                            console.warn(`âš ï¸ è­¦å‘Š: ${fileName} ä¸­çš„é—®é¢˜${index+1}æ²¡æœ‰textå±æ€§`);
                        }
                        if (!question.options) {
                            console.warn(`âš ï¸ è­¦å‘Š: ${fileName} ä¸­çš„é—®é¢˜${index+1}æ²¡æœ‰optionså±æ€§`);
                        }
                    });
                }
            }
        }

        // æŒ‰ç…§åŸå§‹index.htmlçš„é¡ºåºåŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼Œä½†æ·»åŠ æ›´ç»†è‡´çš„é”™è¯¯å¤„ç†
        function loadAllFiles() {
            log('å¼€å§‹åŠ è½½æ‰€æœ‰æ–‡ä»¶...');
            
            // æ–‡ä»¶åŠ è½½é¡ºåº
            const files = [
                // é¦–å…ˆåŠ è½½åŸºç¡€é…ç½®æ–‡ä»¶
                'js/tests.js',
                'data/test-categories.js',
                
                // ç„¶åæŒ‰é¡ºåºåŠ è½½æ‰€æœ‰æµ‹è¯•æ•°æ®æ–‡ä»¶ï¼ˆåˆ†ç»„åŠ è½½ï¼Œä¾¿äºå®šä½é—®é¢˜ï¼‰
                // å¿ƒç†æµ‹è¯„ç±»
                'data/å¿ƒç†æµ‹è¯„ç±»/procrastination_level.js',
                'data/å¿ƒç†æµ‹è¯„ç±»/happiness_index.js',
                'data/å¿ƒç†æµ‹è¯„ç±»/mbti_short.js',
                'data/å¿ƒç†æµ‹è¯„ç±»/emotion_stability.js',
                'data/å¿ƒç†æµ‹è¯„ç±»/stress_tolerance.js',
                'data/å¿ƒç†æµ‹è¯„ç±»/self_confidence.js',
                'data/å¿ƒç†æµ‹è¯„ç±»/introversion_extroversion.js',
                
                // çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/love_philosophy.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/attachment_style.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/ideal_partner.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/intimacy_satisfaction.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/friendship_stability.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/social_anxiety_index.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/love_communication_style.js',
                'data/çˆ±æƒ…ä¸äººé™…å…³ç³»ç±»/attraction_index.js',
                
                // èŒä¸šä¸å­¦ä¹ ç±»
                'data/èŒä¸šä¸å­¦ä¹ ç±»/leadership_index.js',
                'data/èŒä¸šä¸å­¦ä¹ ç±»/creative_thinking.js',
                'data/èŒä¸šä¸å­¦ä¹ ç±»/time_management.js',
                'data/èŒä¸šä¸å­¦ä¹ ç±»/focus_attention.js',
                'data/èŒä¸šä¸å­¦ä¹ ç±»/career_stress_resilience.js',
                'data/èŒä¸šä¸å­¦ä¹ ç±»/communication_skills.js',
                
                // å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/sleep_quality.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/diet_health.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/schedule_regularity.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/mental_subhealth_index.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/exercise_habit_self_assessment.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/mobile_phone_dependency.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/stay_up_late_index.js',
                'data/å¥åº·ä¸ç”Ÿæ´»ä¹ æƒ¯ç±»/sitting_risk_assessment.js',
                
                // æ™ºåŠ›ä¸é€»è¾‘ç±»
                'data/æ™ºåŠ›ä¸é€»è¾‘ç±»/iq60.js',
                
                // æ‰«æå·¥å…·å’Œé…ç½®æ–‡ä»¶
                'data/data-scanner.js',
                'data/test-config.js'
            ];
            
            // è®¾ç½®æ€»æ–‡ä»¶æ•°
            window.DebugState.totalFiles = files.length;
            window.DebugState.currentFileIndex = 0;
            
            // æŒ‰é¡ºåºé€ä¸ªåŠ è½½æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å¹¶è¡ŒåŠ è½½ï¼Œä»¥ä¾¿æ›´å®¹æ˜“å®šä½é—®é¢˜
            function loadNextFile() {
                if (window.DebugState.currentFileIndex >= files.length) {
                    checkAllFilesLoaded();
                    return;
                }
                
                const currentFile = files[window.DebugState.currentFileIndex];
                const fileName = currentFile.split('/').pop();
                
                console.log(`\nåŠ è½½æ–‡ä»¶ ${window.DebugState.currentFileIndex + 1}/${files.length}: ${fileName}`);
                
                loadScript(currentFile, 
                    function() {
                        window.DebugState.currentFileIndex++;
                        // çŸ­æš‚å»¶è¿ŸååŠ è½½ä¸‹ä¸€ä¸ªæ–‡ä»¶
                        setTimeout(loadNextFile, 100);
                    }, 
                    function() {
                        window.DebugState.currentFileIndex++;
                        // å³ä½¿å‡ºç°é”™è¯¯ï¼Œä¹Ÿç»§ç»­åŠ è½½ä¸‹ä¸€ä¸ªæ–‡ä»¶
                        setTimeout(loadNextFile, 100);
                    }
                );
            }
            
            // å¼€å§‹é€ä¸ªåŠ è½½æ–‡ä»¶
            loadNextFile();
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åŠ è½½æ–‡ä»¶
        document.addEventListener('DOMContentLoaded', loadAllFiles);
    </script>
</body>
</html>