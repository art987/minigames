<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒç†æµ‹è¯• - ç­”é¢˜ç•Œé¢</title>
    <link rel="stylesheet" href="run.css">
    <!-- ä½¿ç”¨CDNåŠ è½½html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="js/tests.js"></script>
    <script src="data/test-config.js"></script>
    <!-- æ ¹æ®URLå‚æ•°åŠ¨æ€åŠ è½½å¯¹åº”çš„æµ‹è¯•æ•°æ®æ–‡ä»¶ -->
    <script>
        // è·å–URLå‚æ•°
        function getQueryParam(key) {
            var search = window.location.search.replace(/^\?/, '');
            var map = {};
            var parts = search.split('&');
            for (var i = 0; i < parts.length; i++) {
                if (!parts[i]) continue;
                var kv = parts[i].split('=');
                map[decodeURIComponent(kv[0])] = decodeURIComponent(kv[1] || '');
            }
            return map[key];
        }
        
        // æ ¹æ®æµ‹è¯•IDå’Œåˆ†ç±»åŠ¨æ€åŠ è½½æ•°æ®æ–‡ä»¶
        function loadTestDataFile() {
            var testId = getQueryParam('testId') || getQueryParam('test');
            var category = getQueryParam('category');
            
            if (!testId) {
                testId = 'knowledge23';
                category = 'knowledge';
            }
            
            // åˆ›å»ºæ•°æ®æ–‡ä»¶çš„scriptæ ‡ç­¾
            var script = document.createElement('script');
            
            // ä¼˜å…ˆå°è¯•åŠ è½½æ­£å¸¸ç‰ˆæœ¬ï¼Œå¦‚æœå¤±è´¥å†åŠ è½½å…¼å®¹æ€§ç‰ˆæœ¬
            script.src = 'data/' + category + '/' + testId + '.js';
            
            // å¦‚æœæ­£å¸¸ç‰ˆæœ¬åŠ è½½å¤±è´¥ï¼Œå°è¯•å…¼å®¹æ€§ç‰ˆæœ¬
            script.onerror = function() {
                console.log('æ­£å¸¸ç‰ˆæœ¬åŠ è½½å¤±è´¥ï¼Œå°è¯•åŠ è½½å…¼å®¹æ€§ç‰ˆæœ¬');
                script.src = 'data/' + category + '/' + testId + '-compat.js';
            };
            
            document.head.appendChild(script);
        }
        
        // ç«‹å³æ‰§è¡ŒåŠ è½½
        loadTestDataFile();
    </script>
    <!-- ä½¿ç”¨åŸºç¡€ç‰ˆè¿è¡Œå™¨ -->
    <!-- <script src="js/runner-basic.js"></script> -->
    <!-- å…¶ä»–ç‰ˆæœ¬æš‚æ—¶æ³¨é‡Šæ‰ -->
    <!-- <script src="js/runner-minimal.js"></script> -->
    <!-- <script src="js/runner-fixed.js"></script> -->
    <script src="js/runner.js"></script>
</head>
<body> <div class="header">
           <a href="#" id="back-to-category" class="nav-link">â† è¿”å›åˆ†ç±»åˆ—è¡¨</a>
             <h1 id="test-title"></h1>
            <p class="intro" id="test-intro" style="display: none;"></p>
        </div>
    <div class="container">
       
       
        
        <div id="progress-text">é¢˜ç›® 0/0</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        
        <form id="test-form">
            <!-- é¢˜ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            <p class="error-message hidden">åŠ è½½æµ‹è¯•é¢˜ç›®ä¸­...</p>
        </form>
        
        <div class="navigation">
            <button id="prev-btn" class="btn btn-secondary" disabled="disabled">ä¸Šä¸€é¢˜</button>
            <button id="next-btn" class="btn btn-primary" disabled="disabled">ä¸‹ä¸€é¢˜</button>
        </div>
        
        <button id="submit-btn" class="btn btn-submit hidden">æäº¤</button>
        <button id="reset-btn" class="btn btn-reset">é‡æ–°æµ‹è¯•</button>
        
        <!-- å®Œæˆæç¤ºå¼¹çª— -->
        <div id="completion-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="modal-title">æ‚¨çœŸæ£’ï¼</h3>
                <p class="modal-text">æ‚¨å·²ç»å®Œæˆæ‰€æœ‰é¢˜ç›®çš„æµ‹è¯•ï¼Œæ˜¯å¦æäº¤ç­”æ¡ˆå¹¶æŸ¥çœ‹ç»“æœï¼Ÿ</p>
                <div class="modal-buttons">
                    <button id="review-btn" class="btn btn-white">å†çœ‹çœ‹</button>
                    <button id="submit-result-btn" class="btn btn-purple">æŸ¥çœ‹ç»“æœ</button>
                </div>
            </div>
        </div>
        
        <div id="result-section" class="result-section hidden">
            <div id="result-card" class="certificate"> 
                <div class="certificate-header"> 
                    <div class="certificate-logo">ğŸ§ </div> 
                    <h2 class="certificate-title">èƒ½åŠ›æµ‹è¯„è¯ä¹¦</h2> 
                    <h3 class="certificate-subtitle">Ability Assessment Certificate</h3>
                </div> 
                <div class="certificate-content"> 
                    <div class="certificate-decoration left-decoration"></div> 
                    <div class="certificate-main"> 
                        <p class="certificate-intro">å…¹è¯æ˜ï¼Œæ‚¨å·²å®Œæˆ</p> 
                        <h3 id="certificate-test-name" class="certificate-test-name">çŸ¥è¯†å¤§æµ‹è¯•</h3> 
                        <div class="certificate-score-container"> 
                            <div class="certificate-score-circle"> 
                                <span id="total-score" class="certificate-score">0</span>
                                <span class="certificate-score-unit">åˆ†</span>
                                <span id="total-possible-score" class="certificate-total-score">æ€»åˆ†100</span> 
                            </div> 
                            <p class="certificate-level">ç­‰çº§ï¼š<span id="score-level" class="certificate-level-value">åˆé˜¶</span></p> 
                        </div> 
                        <div class="certificate-text" id="result-text">æƒ…ç»ªä¸å…³ç³»ç®¡ç†å¾…åŠ å¼ºã€‚</div> 
                        <div class="certificate-advice" id="result-advice">å»ºè®®ï¼šè®°å½•æƒ…ç»ªABCäº‹ä»¶ï¼Œç»ƒä¹ éæš´åŠ›æ²Ÿé€šã€‚</div> 
                        <div class="certificate-date"><span id="test-date">2025å¹´09æœˆ20æ—¥</span></div> 
                    </div> 
                    <div class="certificate-decoration right-decoration"></div> 
                </div> 
                <div class="certificate-footer"> 
                    <div class="certificate-seal"></div> 
                    <div class="certificate-signature"> 
                        
                        <p>å°æœ¬æœ¬å¿ƒç†æµ‹è¯•ä¸­å¿ƒ</p> 
                        <div class="signature-line"></div> 
                    </div> 
                </div> 
            </div> 
            <div class="actions certificate-actions"> 
                <button id="save-image" type="button" class="btn btn-save">ä¿å­˜è¯ä¹¦</button> 
                <button id="share-result" type="button" class="btn btn-share">åˆ†äº«ç»“æœ</button> 
            </div> 
            
            <!-- ç­”é¢˜è¯¦æƒ…ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰ -->
            <div class="answers-detail" id="answers-detail">
                <h3 class="answers-title">ç­”é¢˜è¯¦æƒ…</h3>
                <!-- ç­”é¢˜è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆå§‹åŒ–æµ‹è¯•');
            
            // å®šä¹‰é‡è¯•æ¬¡æ•°å’Œåˆå§‹å»¶è¿Ÿæ—¶é—´
            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 500;
            const retryDelay = 1000;
            
            // åˆå§‹åŒ–æµ‹è¯•å‡½æ•°ï¼Œæ”¯æŒé‡è¯•
            function initTest() {
                if (window.TestRunner && typeof window.TestRunner.bootstrap === 'function') {
                    try {
                        console.log(`è°ƒç”¨TestRunner.bootstrap()åˆå§‹åŒ–æµ‹è¯•${retries > 0 ? ' (é‡è¯•' + retries + ')' : ''}`);
                        window.TestRunner.bootstrap();
                    } catch (error) {
                        console.error('TestRunner.bootstrapæ‰§è¡Œå¤±è´¥:', error);
                        document.getElementById('test-form').innerHTML = `
                            <p class="error-message">æµ‹è¯•åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>
                        `;
                    }
                } else {
                    retries++;
                    if (retries <= maxRetries) {
                        console.log(`TestRunnerå¯¹è±¡æœªå‡†å¤‡å¥½ï¼Œ${retryDelay}msåé‡è¯•... (${retries}/${maxRetries})`);
                        setTimeout(initTest, retryDelay);
                    } else {
                        console.error('TestRunnerå¯¹è±¡æˆ–bootstrapå‡½æ•°ä¸å­˜åœ¨ï¼Œé‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™');
                        document.getElementById('test-form').innerHTML = `
                            <p class="error-message">æµ‹è¯•ç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>
                        `;
                    }
                }
            }
            
            // æ·»åŠ åˆ†äº«åŠŸèƒ½æ”¯æŒ
            function setupShareButton() {
                const shareButton = document.getElementById('share-result');
                if (shareButton) {
                    shareButton.addEventListener('click', function() {
                        // å°è¯•ä½¿ç”¨Web Share API
                        if (navigator.share) {
                            const testTitle = document.getElementById('test-title')?.textContent || 'èƒ½åŠ›æµ‹è¯„';
                            const score = document.getElementById('total-score')?.textContent || '0';
                            const level = document.getElementById('score-level')?.textContent || 'æœªçŸ¥';
                            
                            const shareData = {
                                title: `æˆ‘åœ¨ã€Œ${testTitle}ã€ä¸­è·å¾—äº†${score}åˆ†ï¼Œç­‰çº§ï¼š${level}`,
                                text: 'å¿«æ¥æŒ‘æˆ˜è¿™ä¸ªæœ‰è¶£çš„å¿ƒç†æµ‹è¯•å§ï¼',
                                url: window.location.href
                            };
                            
                            navigator.share(shareData).catch((error) => {
                                console.log('åˆ†äº«å¤±è´¥:', error);
                                showShareFallback();
                            });
                        } else {
                            // é™çº§æ–¹æ¡ˆï¼šå¤åˆ¶ç»“æœåˆ°å‰ªè´´æ¿
                            showShareFallback();
                        }
                    });
                }
            }
            
            // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºåˆ†äº«æç¤ºæˆ–å¤åˆ¶é“¾æ¥
            function showShareFallback() {
                const testTitle = document.getElementById('test-title')?.textContent || 'èƒ½åŠ›æµ‹è¯„';
                const score = document.getElementById('total-score')?.textContent || '0';
                const level = document.getElementById('score-level')?.textContent || 'æœªçŸ¥';
                
                // åˆ›å»ºåˆ†äº«å†…å®¹
                const shareText = `æˆ‘åœ¨ã€Œ${testTitle}ã€ä¸­è·å¾—äº†${score}åˆ†ï¼Œç­‰çº§ï¼š${level}\nå¿«æ¥æŒ‘æˆ˜è¿™ä¸ªæœ‰è¶£çš„å¿ƒç†æµ‹è¯•å§ï¼\n${window.location.href}`;
                
                // å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('æµ‹è¯•ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ†äº«ç»™å¥½å‹ï¼');
                }).catch(() => {
                    // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºå¼¹çª—è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                    alert(`æµ‹è¯•ç»“æœï¼š\n${shareText}\n\nè¯·æ‰‹åŠ¨å¤åˆ¶æ­¤å†…å®¹åˆ†äº«ç»™å¥½å‹ã€‚`);
                });
            }
            
            // åœ¨TestRunneråˆå§‹åŒ–åè®¾ç½®åˆ†äº«æŒ‰é’®
            setTimeout(() => {
                setupShareButton();
            }, initialDelay + 1000);
            
            // ç»™TestRunnerä¸€äº›æ—¶é—´æ¥åŠ è½½æ•°æ®æ–‡ä»¶ï¼Œå¢åŠ åˆå§‹å»¶è¿Ÿæ—¶é—´ä»¥ç¡®ä¿æ•°æ®æ–‡ä»¶åŠ è½½å®Œæˆ
            setTimeout(initTest, initialDelay);
        });
        
        // ç»™è¿”å›åˆ†ç±»åˆ—è¡¨æŒ‰é’®æ·»åŠ åŠŸèƒ½
        document.getElementById('back-to-category').addEventListener('click', function(e) {
            e.preventDefault();
            
            // è·å–URLä¸­çš„categoryå‚æ•°
            const category = getQueryParam('category');
            
            // å¦‚æœæœ‰categoryå‚æ•°ï¼Œè¿”å›è¯¥åˆ†ç±»çš„åˆ—è¡¨é¡µï¼›å¦åˆ™è¿”å›é¦–é¡µ
            if (category) {
                window.location.href = 'index.html?showCategory=' + encodeURIComponent(category);
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>



