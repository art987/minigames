<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å§‹æµ‹è¯•</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="site-header">
        <div class="header-top">
            <a href="index.html" class="back">â† è¿”å›</a>
            <h1 id="test-title">åŠ è½½ä¸­â€¦</h1>
        </div>
        <div class="progress-info">
            <div id="progress-text" style="font-size: 14px; color: var(--muted);">é¢˜ç›® 0/0</div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
    </header>

    <main class="container">
        <div id="test-intro" class="intro" style="display: none;"></div>

        <form id="test-form" class="test-form">
            <!-- é—®é¢˜å°†è¢«åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </form>

        <div class="question-nav">
            <button id="prev-btn" class="secondary" disabled>ä¸Šä¸€é¢˜</button>
            <button id="next-btn" class="primary">ä¸‹ä¸€é¢˜</button>
        </div>

        <div class="actions">
            <button id="submit-btn" class="primary" style="display: none;">æäº¤å¹¶æŸ¥çœ‹ç»“æœ</button>
            <button id="reset-btn" type="button" class="secondary">é‡ç½®</button>
        </div>

        <section id="result-section" class="result hidden">
            <h2>æµ‹è¯•ç»“æœ</h2>
            <div id="result-card" class="certificate">
                <div class="certificate-header">
                    <div class="certificate-logo">ğŸ§ </div>
                    <h2 class="certificate-title">èƒ½åŠ›æµ‹è¯„è¯ä¹¦</h2>
                </div>
                <div class="certificate-content">
                    <div class="certificate-decoration left-decoration"></div>
                    <div class="certificate-main">
                        <p class="certificate-intro">å…¹è¯æ˜ï¼Œæ‚¨å·²å®Œæˆ</p>
                        <h3 id="certificate-test-name" class="certificate-test-name">æ™ºåŠ›æµ‹è¯•</h3>
                        <div class="certificate-score-container">
                            <div class="certificate-score-circle">
                                <span id="total-score" class="certificate-score">0</span>
                            </div>
                            <p class="certificate-level">ç­‰çº§ï¼š<span id="score-level" class="certificate-level-value">-</span></p>
                        </div>
                        <div class="certificate-text" id="result-text"></div>
                        <div class="certificate-advice" id="result-advice"></div>
                        <div class="certificate-date">æµ‹è¯•æ—¥æœŸï¼š<span id="test-date"></span></div>
                    </div>
                    <div class="certificate-decoration right-decoration"></div>
                </div>
                <div class="certificate-footer">
                    <div class="certificate-seal"></div>
                    <div class="certificate-signature">
                        <div class="signature-line"></div>
                        <p>å¿ƒç†æµ‹è¯•ä¸­å¿ƒ</p>
                    </div>
                </div>
            </div>
            <div class="actions certificate-actions">
                <button id="save-image" type="button" class="primary">ä¿å­˜è¯ä¹¦</button>
                <button id="share-result" type="button" class="secondary">åˆ†äº«ç»“æœ</button>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="js/tests.js"></script>
    <script src="js/runner.js"></script>
    <script src="data/iq.js"></script>
    <script src="data/eq.js"></script>
    <script src="data/iq60.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–å…¨å±€å˜é‡
        window.questionContainers = [];
        window.currentQuestionIndex = 0;
        window.totalQuestions = 0;
        
        // æ­£å¸¸é€šè¿‡TestRunneråŠ è½½æµ‹è¯•
        if (window.TestRunner) {
            window.TestRunner.bootstrap();
        }
        
        // å¦‚æœURLå‚æ•°æ˜¯iq60ä½†æ²¡æœ‰æ­£ç¡®åŠ è½½ï¼Œç›´æ¥ä½¿ç”¨TestDatasetsåŠ è½½
        if (location.search.indexOf('test=iq60') !== -1 && document.getElementById('test-form').children.length === 0) {
            var dataset = window.TestDatasets && window.TestDatasets['iq60'];
            if (dataset) {
                document.getElementById('test-title').textContent = '60é¢˜æ ‡å‡†æ™ºå•†æµ‹è¯•';
                document.getElementById('test-intro').textContent = 'ç»å…¸60é¢˜æ™ºå•†æµ‹è¯•ï¼Œå…¨é¢è¯„ä¼°é€»è¾‘æ¨ç†ã€ç©ºé—´æƒ³è±¡ã€æ•°å­—è¿ç®—å’Œæ¨¡å¼è¯†åˆ«èƒ½åŠ›ã€‚æµ‹è¯•æ—¶é—´çº¦30åˆ†é’Ÿã€‚';
                
                var form = document.getElementById('test-form');
                dataset.questions.forEach(function(q, idx) {
                    var wrap = document.createElement('div');
                    wrap.className = 'q';
                    
                    var title = document.createElement('p');
                    title.className = 'q-title';
                    title.textContent = (idx+1) + '. ' + q.text;
                    wrap.appendChild(title);
                    
                    var options = document.createElement('div');
                    options.className = 'options';
                    q.options.forEach(function(opt, oi) {
                        var label = document.createElement('label');
                        label.className = 'option';
                        var input = document.createElement('input');
                        input.type = q.multi ? 'checkbox' : 'radio';
                        input.name = 'q_' + idx;
                        input.value = String(oi);
                        label.appendChild(input);
                        var span = document.createElement('span');
                        span.textContent = opt.label;
                        label.appendChild(span);
                        options.appendChild(label);
                    });
                    wrap.appendChild(options);
                    form.appendChild(wrap);
                });
            }
        }
        
        // åˆå§‹åŒ–è¿›åº¦æ¡å’Œå¯¼èˆª
        var submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
            submitBtn.style.display = 'none';
        }

        // è®¾ç½®å½“å‰æ—¥æœŸ
        document.getElementById('test-date').textContent = formatDate(new Date());

        // æ·»åŠ åˆ†äº«åŠŸèƒ½
        document.getElementById('share-result').addEventListener('click', function() {
            shareResult();
        });

        // å¢å¼ºä¿å­˜å›¾ç‰‡åŠŸèƒ½
        var saveImageBtn = document.getElementById('save-image');
        if (saveImageBtn) {
            saveImageBtn.addEventListener('click', function() {
                var resultCard = document.getElementById('result-card');
                
                // æ·»åŠ æ°´å°
                var watermark = document.createElement('div');
                watermark.className = 'certificate-watermark';
                watermark.textContent = 'å¿ƒç†æµ‹è¯•ä¸­å¿ƒ';
                resultCard.appendChild(watermark);
                
                html2canvas(resultCard, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    onclone: function(clonedDoc) {
                        var clonedResult = clonedDoc.getElementById('result-card');
                        clonedResult.style.transform = 'scale(1)';
                        clonedResult.style.borderRadius = '0';
                    }
                }).then(function(canvas) {
                    // ç§»é™¤æ°´å°
                    resultCard.removeChild(watermark);
                    
                    // ä¿å­˜å›¾ç‰‡
                    var link = document.createElement('a');
                    link.download = 'å¿ƒç†æµ‹è¯•è¯ä¹¦_' + new Date().getTime() + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            });
        }
    });

    // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYYå¹´MMæœˆDDæ—¥
    function formatDate(date) {
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();
        return year + 'å¹´' + (month < 10 ? '0' + month : month) + 'æœˆ' + (day < 10 ? '0' + day : day) + 'æ—¥';
    }

    // åˆ†äº«ç»“æœ
    function shareResult() {
        var testName = document.getElementById('certificate-test-name').textContent;
        var score = document.getElementById('total-score').textContent;
        var level = document.getElementById('score-level').textContent;
        
        var shareText = 'æˆ‘åœ¨å¿ƒç†æµ‹è¯•ä¸­å¿ƒå®Œæˆäº†ã€' + testName + 'ã€‘æµ‹è¯•ï¼Œè·å¾—äº†' + score + 'åˆ†ï¼Œç­‰çº§ä¸ºã€' + level + 'ã€‘ï¼Œå¿«æ¥æµ‹è¯•ä¸€ä¸‹ä½ çš„èƒ½åŠ›å§ï¼';
        
        // æ£€æŸ¥æ˜¯å¦æ”¯æŒWeb Share API
        if (navigator.share) {
            navigator.share({
                title: 'å¿ƒç†æµ‹è¯•ç»“æœåˆ†äº«',
                text: shareText,
                url: window.location.href
            }).catch(function(error) {
                console.log('åˆ†äº«å¤±è´¥:', error);
                fallbackShare(shareText);
            });
        } else {
            fallbackShare(shareText);
        }
    }

    // å¤‡ç”¨åˆ†äº«æ–¹æ³•
    function fallbackShare(text) {
        // åˆ›å»ºä¸´æ—¶è¾“å…¥æ¡†
        var input = document.createElement('textarea');
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('åˆ†äº«æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæ‚¨å¯ä»¥ç²˜è´´åˆ°ç¤¾äº¤åª’ä½“åˆ†äº«ï¼');
    }
    </script>
</body>
</html>



